@model SrFaktura


<div class="container">




    @if (ViewBag.Admin == true)
    {
        <form asp-page-handler="PDF" class="needs-validation" novalidate id="form1">
            <div class="row mt-3">

                <div class="alert alert-primary" role="alert">
                    <strong>Stanični račun K-1P</strong>
                </div>

                <div class="col-md-2">
                    <label>Stanica</label>
                    <input class="form-control form-control-sm" list="myDatalistSR" id="myDatalistInputSR" name="stanica" value="@ViewBag.Stanica" autocomplete="off" required />
                    <datalist id="myDatalistSR" open="open">
                    </datalist>
                    <div class="invalid-feedback">
                        Unesite naziv stanice.
                    </div>
                </div>

                <div class="col-md-2">
                    <label>Godina</label>
                    <input class="form-control form-control-sm" name="fakturaGod" id="fakturaGod" value="@ViewBag.FakturaGod" autocomplete="off" required />
                    <div class="invalid-feedback">
                        Unesite godinu.
                    </div>
                </div>

                <div class="col-md-2">
                    <label>Broj računa</label>
                    <input class="form-control form-control-sm" name="racunBr" id="racunBr" autocomplete="off" />
                    <div class="invalid-feedback">
                        Unesite broj računa.
                    </div>
                </div>

                <div class="col-xxl-1 col-xl-1 col-lg col-md mt-4">
                    <button class="btn btn-sm btn-primary" style="margin-top:7px" asp-controller="StanicniRacun" asp-action="PDF" id="pretraziBtn" >Pretraži</button>
                </div>

            </div>
        </form>


    }
    else
    {
        /***************************** PRVI SEKTOR KADA KORISNIK NIJE ADMIN *************************************/
        /***************************** PRVI RED *****************************************************************/

        <form asp-page-handler="Save" class="needs-validation" novalidate enctype="multipart/form-data">

            <div class="row mt-3">

                <div class="alert alert-primary" role="alert">
                    <strong>Unos stanične fakture.</strong>
                </div>


                @if (ViewBag.Admin == true)
                {
                    <div class="col-md-3">
                        <label class="mb-0">Stanica</label>
                        <input class="form-control form-control-sm" list="myDatalist" id="myDatalistInput" required autocomplete="off" />
                        <datalist id="myDatalist" open="open">
                        </datalist>
                        <div class="invalid-feedback">
                            Unesite stanicu.
                        </div>
                    </div>

                }
                else
                {
                    <div class="col-md-3">
                        <label class="mb-0">Stanica</label>
                        <input class="form-control form-control-sm" value="@ViewBag.Stanica" readonly />
                    </div>
                }

                <div class="col-md-3">
                    <label class="mb-0">Šifra</label>
                    <input class="form-control form-control-sm" autocomplete="off" value="@ViewBag.SifraStanice" asp-for="Stanica" />
                </div>

                <div class="col-md-2">
                    <label class="mb-0">Mesto izdavanja računa</label>
                    <input class="form-control form-control-sm" autocomplete="off" value="@ViewBag.MestoIzdavanjaRacuna" />
                </div>

            </div>


            @*/***************************** DRUGI RED *****************************************************************/*@

            <div class="row">
                <div class="col-md-3">
                    <label class="mb-0">Blagajna</label>
                    <select class="form-select form-select-sm" aria-label="Default select example" name="tipBlagajna" asp-items="@ViewBag.BlagajnaTip" required>
                        @*<option></option>
                        <option value="P">Prispeća</option>
                        <option value="O">Otpravljanja</option>*@
                    </select>
                    <div class="invalid-feedback">
                        Unesite tip blagajne.
                    </div>
                </div>

                @*<div class="col-md-3">
                    <label class="mb-0">Šifra</label>
                    <select class="form-select form-select-sm" aria-label="Default select example" name="blagajna" asp-for="Blagajna">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>*@

                <div class="col-md-3">
                    <label class="mb-0">Šifra</label>
                    <input class="form-control form-control-sm" autocomplete="off" value="@ViewBag.SifraBlagajne" asp-for="Blagajna" />
                </div>

                <div class="col-md-2">
                    <label class="mb-0">Tekući račun</label>
                    <input class="form-control form-control-sm" autocomplete="off" asp-for="TekuciRacun" required />
                    <div class="invalid-feedback">
                        Unesite tekući račun.
                    </div>
                </div>

                <div class="col-md">
                    <div class="row d-flex justify-content-between">
                        <div class="col-md">
                            <label class="mb-0">Matični br.</label>
                            <input class="form-control form-control-sm" autocomplete="off" value="21127116" />
                        </div>

                        <div class="col-md">
                            <label class="mb-0">PIB</label>
                            <input class="form-control form-control-sm" autocomplete="off" value="109108446" />
                        </div>
                    </div>
                </div>



            </div>

            <div class="my-2">
                <hr />
            </div>
            @*/***************************** DRUGI SEKTOR **************************************************************/
            /***************************** TREĆI RED *****************************************************************/*@


        <div class="row mt-3">

            <div class="col-md-2">
                <label class="mb-0">Račun broj</label>
                <input class="form-control form-control-sm" autocomplete="off" asp-for="FakturaBroj" required />
                <div class="invalid-feedback">
                    Unesite broj računa.
                </div>
            </div>

            <div class="col-md-1">
                <label class="mb-0">Godina</label>
                <input class="form-control form-control-sm" autocomplete="off" id="godinaRacun" asp-for="FakturaGodina" />
            </div>

            <div class="col-md-3">
                <label class="mb-0">Naziv primaoca računa</label>
                <input class="form-control form-control-sm" list="myDatalistNPR" id="myDatalistInputNPR" autocomplete="off" required asp-for="Primalac" />
                <datalist id="myDatalistNPR" open="open">
                </datalist>
                <div class="invalid-feedback">
                    Unesite naziv primaoca.
                </div>
            </div>

            <div class="col-md-2">
                <label class="mb-0">Broj ugovora</label>
                <input class="form-control form-control-sm" autocomplete="off" id="brUgovora" asp-for="PrimalacUg" />
            </div>

            <div class="col-md-2">
                <label class="mb-0">Telefon</label>
                <input class="form-control form-control-sm" autocomplete="off" id="telefon" asp-for="PrimalacTelefon" />
            </div>
            <div class="col-md-2">
                <label class="mb-0">Tekući račun</label>
                <input class="form-control form-control-sm" autocomplete="off" id="tr" asp-for="PrimalacTr" required/>
                <div class="invalid-feedback">
                    Unesite tekući račun.
                </div>
            </div>

        </div>

            @*/***************************** ČETVRTI RED *****************************************************************/*@

            <div class="row">

                <div class="col-md-3">
                
                </div>
          

                <div class="col-md-3">
                    <label class="mb-0">Mesto</label>
                    <input class="form-control form-control-sm" autocomplete="off" id="mesto" />
                </div>

                <div class="col-md-2">
                    <label class="mb-0">Ulica i broj</label>
                    <input class="form-control form-control-sm" autocomplete="off" id="adresa" asp-for="PrimalacAdresa" />
                </div>

                <div class="col-md-2">
                    <label class="mb-0">Matični br.</label>
                    <input class="form-control form-control-sm" autocomplete="off" id="mb" asp-for="PrimalacMb" />
                </div>

                <div class="col-md-2">
                    <label class="mb-0">PIB</label>
                    <input class="form-control form-control-sm" autocomplete="off" id="pib" asp-for="PrimalacPib" />
                </div>

            </div>



            <div class="my-2">
                <hr />
            </div>

            @*/***************************** TREĆI SEKTOR **************************************************************/*@


            <div class="row">

                <div class="col-md-2">
                    <label class="mb-0">Datum nastanka obaveze</label>
                    <input class="form-control form-control-sm" autocomplete="off" type="text" id="DatumNO" name="DatumNO" asp-for="FakturaDatum" required asp-format="{0:dd\.MM\.yyyy}"/>
                    <div class="invalid-feedback">
                        Unesite datum.
                    </div>
                </div>

                <div class="col-md-2">
                    <label class="mb-0">Datum plaćanja</label>
                    <input class="form-control form-control-sm" autocomplete="off" type="text" id="DatumP" name="DatumP" asp-for="FakturaDatumP" required asp-format="{0:dd\.MM\.yyyy}"/>
                    <div class="invalid-feedback">
                        Unesite datum.
                    </div>
                </div>

                <div class="col-md-3">
                    <label for="formFileSm" class="form-label mb-0">Prilog fakturi</label>
                    <input class="form-control form-control-sm" id="formFileSm" type="file" asp-for="Fpath" asp-items="@ViewBag.Putanja" required>
                    <div class="invalid-feedback">
                        Odaberite fajl.
                    </div>
                </div>

            </div>

            @*/***************************        VRSTA USLUGA I DOBARA    ********************************************/*@

            <div class="row d-flex align-items-end mt-1">
                <div class="col-md">
                    <label class="mb-0">Vrsta dobara ili usluga</label>
                    <textarea class="form-control form-control-sm" id="exampleFormControlTextarea1" rows="4" asp-for="VrstaUslugaOpis" required></textarea>
                    <div class="invalid-feedback">
                        Unesite vrstu dobara ili usluga.
                    </div>
                </div>

            </div>


            <div class="row d-flex align-items-end mt-1">

                <div class="col-md-4">
                    @*<label class="mb-0">Vrsta dobara ili usluga</label>
                        <textarea class="form-control form-control-sm" id="exampleFormControlTextarea1" rows="4" asp-for="VrstaUslugaOpis"></textarea>*@
                </div>

                <div class="col-md-2">
                    <label class="mb-0">Datum prometa usluga</label>
                    <input class="form-control form-control-sm" autocomplete="off" type="text" id="DatumPU" name="DatumPU" asp-for="FakturaDatumPromet" required asp-format="{0:dd\.MM\.yyyy}"/>
                  
                </div>
                <div class="col-md-1">
                    <label class="mb-0">Jed. mera</label>
                    <input class="form-control form-control-sm" autocomplete="off" asp-for="Fjedinica" />
                </div>
                <div class="col-md-1">
                    <label class="mb-0">Količina</label>
                    <input class="form-control form-control-sm" autocomplete="off" asp-for="Fkolicina"/>
                </div>
                <div class="col-md-2">
                    <label class="mb-0">Jedinična cena dinara</label>
                    <input class="form-control form-control-sm" autocomplete="off" asp-for="Fjcena"/>
                </div>
                <div class="col-md-2">
                    <div class="row">
                        <div class="col-auto pr-0">
                            <label class="mb-0">Ukupno dinara</label>
                            <input class="form-control form-control-sm" autocomplete="off" id="ukupnoDinara" asp-for="FakturaOsnovica" required />
                            
                        </div>
                        <div class="col-auto px-1 pt-4" style="padding-top:2px" >
                            <i class="bi bi-info-circle"  data-bs-toggle="tooltip" data-bs-placement="top" title="Unosi se osnovica."></i>
                        </div>
                    </div>
                    
                </div>
            </div>

            @*/***************************        POREZI    ********************************************/*@

            <div class="row border-bottom d-flex justify-content-between mt-3">
                <div class="col-md-3">
                    <label class="mb-0">Poreska osnovica</label>
                </div>
                <div class="col-md-2">
                    <input class="form-control form-control-sm" autocomplete="off" id="poreskaOsnovica" asp-for="FakturaOsnovica" required />
                    <div class="invalid-feedback">
                        Unesite iznos.
                    </div>
                </div>
            </div>

            <div class="row border-bottom d-flex justify-content-between mt-1">
                <div class="col-md-3">
                    <label class="mb-0">Poreska stopa  % i iznos PDV</label>
                </div>
                <div class="col-md-2">
                    <input class="form-control form-control-sm" autocomplete="off" id="pdv" asp-for="FakturaPdv" />
                </div>
            </div>

            <div class="row border-bottom d-flex justify-content-between mt-1">
                <div class="col-md-3">
                    <label class="mb-0">Ukupna vrednost:</label>
                </div>
                <div class="col-md-2">
                    <input class="form-control form-control-sm" autocomplete="off" id="ukupnaVrednost" asp-for="FakturaTotal" required />
                    <div class="invalid-feedback">
                        Unesite iznos.
                    </div>
                </div>
            </div>

            <div class="row border-bottom d-flex justify-content-start mt-1">
                <div class="col-md-5">
                    <label class="mb-0">Oslobođeno PDV: Čl.&nbsp;&nbsp;&nbsp;&nbsp;Stav.&nbsp;&nbsp;&nbsp;&nbsp;Tač.&nbsp;&nbsp;&nbsp;&nbsp;Zakona </label>
                </div>

            </div>



            <div class="row d-flex align-items-end mt-3">
                <div class="col-md-2">
                    <label class="mb-0">Fakturisao</label>
                    <input class="form-control form-control-sm" autocomplete="off" value="@ViewBag.blagajnik" required/>
                    <input hidden value="@ViewBag.UserID" asp-for="Blagajnik" />        @*koristi UserID da se upise u bazu*@
                    <div class="valid-feedback">
                        <p class="text-white m-0">Looks good!</p>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="mb-0">Datum izdavanja</label>
                    <input class="form-control form-control-sm" autocomplete="off" type="text" id="DatumI" name="DatumI" asp-for="DatumIzdavanja"  required asp-format="{0:dd\.MM\.yyyy}" />
                    <div class="invalid-feedback">
                        Unesite datum.
                    </div>
                </div>
                <div class="col-md-2 form-inline">

                    @if (Model == null)
                    {

                        <button type="submit" class="btn btn-sm btn-primary" asp-controller="StanicniRacun" asp-action="Save">Upiši u bazu</button>
                        @if (ViewBag.PDFbtn == true)
                        {
                            <a class="btn btn-sm btn-primary mx-2" asp-controller="StanicniRacun" asp-action="LastEntryPDF" target="_blank">PDF</a>
                        }
                    }
                    else
                    {
                        <button type="submit" class="btn btn-sm btn-primary" asp-controller="StanicniRacun" asp-action="EditSave">Izmeni</button>
                    }

                </div>
            </div>




        </form>

    }



    @if (((IEnumerable<SrFaktura>)ViewBag.stanicniRacuni).Any())
    {
        <div>
            <table class="table table-hover mt-5">
                <thead>
                    <tr>
                        <th scope="col">Stanica</th>
                        <th scope="col">FakturaBroj</th>
                        <th scope="col">FakturaDatum</th>
                        <th scope="col">Primalac</th>
                        <th scope="col">Prikaži</th>

                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ((IEnumerable<SrFaktura>)ViewBag.stanicniRacuni))
                    {
                    <tr>
                        <td scope="row">@item.Stanica</td>
                        <td>@item.FakturaBroj</td>

                        @if (item.FakturaDatum.HasValue)
                        {
                            <td>@item.FakturaDatum.Value.ToString("dd.MM.yyyy")</td>
                        }
                        else
                        {
                            <td></td>
                        }

                        <td>@item.Primalac</td>
                        <td>
                            <a class="btn btn-sm btn-primary" role="button" asp-controller="StanicniRacun" asp-action="PDF" asp-route-stanica="@item.Stanica" asp-route-racunBr="@item.FakturaBroj" target="_blank">PDF</a>
                            @if (ViewBag.Admin == false)
                            {
                                <a class="btn btn-sm btn-primary" role="button" asp-controller="StanicniRacun" asp-action="Edit" asp-route-stanica="@item.Stanica" asp-route-racunBr="@item.FakturaBroj" asp-route-fakturaGod="@item.FakturaGodina">Izmeni</a>
                            }
                            else
                            {
                                <a class="btn btn-sm btn-primary" role="button" asp-controller="StanicniRacun" asp-action="Realizovano" asp-route-stanica="@item.Stanica" asp-route-racunBr="@item.FakturaBroj" asp-route-fakturaGod="@item.FakturaGodina">Realizovano</a>
                            }

                        </td>
                        

                    </tr>
                    }
                </tbody>

            </table>
        </div>
    }





</div>








@section Scripts {
    <script type="text/javascript">


        $(window).on('load', function () {

            $('#DatumP, #DatumPU, #DatumI, #DatumNO').datepicker()

             //setuje sadašnju godinu               
            $('#godinaRacun').val(new Date().getFullYear())

            $('#myDatalistInputNPR').on('input', function () {

                var input = $('#myDatalistInputNPR').val()

                //var getUrl = window.location;
                //var baseUrl = getUrl.protocol + "//" + getUrl.host + "/" + getUrl.pathname.split('/')[1];

                //console.log("baseUrl " + baseUrl)
                //ovo radi na hostingu, na mom racunaru ne radi. Da bi radilo mora da bude url: "/ListaStanica/KomintentIUgovor"

                $.ajax({
                    type: "GET",
                  //  url: baseUrl + "/ListaStanica/KomintentIUgovor",
                    url: "/ListaStanica/KomintentIUgovor",
                    cache: false,
                    data: { data: input },
                    success: function (data) {
                        var options = '';
                        var object;
                        $.each(data, function (key, value) {

                            options += '<option value="' + value.naziv + '" />';
                            object = value 
                        })

                        $('#myDatalistNPR').html(options)

                        //kada nema u polju nista onda izbaci grešku zato ide try catxh
                        try {
                            var naziv = object.naziv
                        } catch (e) {
                            naziv = null
                        }

                        // ako je ono sto je uneto u polje "Naziv pirmaoca računa" i sa onim što je našao u bazi popuni ostala polja
                        if (input == naziv) {
                       
                            $('#brUgovora').val(object.brojUgovora);
                            $('#mesto').val(object.mesto);
                            $('#adresa').val(object.adresa);
                            $('#telefon').val(object.telefon);
                            $('#tr').val(object.tr);
                            $('#mb').val(object.mb);
                            $('#pib').val(object.pib);

                            //***/

                       
                          

                            var sirinaTeksta = $('#tr').textWidth()
                            var sirina = $('#tr').width()

                            if (sirinaTeksta > sirina) {
                                console.log("vece je sirina teksta od sirine input polja")
                                //var text_input = $('#tr');
                                //text_input.css("font-size", "8px");

                                //$('#tr').val(text_input)

                                //$('#tr').css("font-size", "10");

                                $("#tr")[0].style.fontSize = "8px";
                            }


                            var size = $("#pib").css("font-size");
                            var sizeTr = $("#tr").css("font-size");
                            size = parseInt(size, 10);
                            sizeTr = parseInt(sizeTr, 10);
                            console.log("size " + size)
                            console.log("sizeTr " + sizeTr)



                            console.log("sirina " + sirina)

                        } else {
                            $('#brUgovora').val('');
                            $('#mesto').val('');
                            $('#adresa').val('');
                            $('#telefon').val('');
                            $('#tr').val('');
                            $('#mb').val('');
                            $('#pib').val('');
                        }

                        //myDatalistInputNPR je pridodat funkciji koja dozvoljava samo unos slova je u site.js
                    }
                });
            })

            var sirina = $('#tr').width()
            console.log("sirina " + sirina)

            //$('#tr').on('input', function () {
            //    $(this).textWidth()
                
            //})

             //ODERDJUJE VELICINU TEKSTA
            $.fn.textWidth = function (text, font) {
                if (!$.fn.textWidth.fakeEl) $.fn.textWidth.fakeEl = $('<span>').hide().appendTo(document.body);
                $.fn.textWidth.fakeEl.text(text || this.val() || this.text()).css('font', font || this.css('font'));
                console.log($.fn.textWidth.fakeEl.width())
                return $.fn.textWidth.fakeEl.width();
            };

            //$('#tr').on('input', function () {
            //    $('#' + this.id + '-width').html($(this).textWidth() + 'px');
            //}).trigger('input');







        }) // kraj  $(window).on('load', function () {

        $(document).ready(function () {

            $('#ukupnoDinara').on('input', function () {                                        // da na osnovu unosa polja "Unosa dinara" popuni polja poreska osnovica, PDV, i Ukupna vrednost. Sa zaokruženim vrednodnostima decimala na pr 12,46 => 12,50

                decimals(this.getAttribute('Id'), this.value, 18, 2)
                numbersAndDotOnly(this.getAttribute('Id'), this.value)

                var ukupnoDinara = $('#ukupnoDinara').val()
                var poreskaOsnovica = numberFormat(parseFloat(ukupnoDinara).toFixed(1)) + '0'
                var pdv = numberFormat((poreskaOsnovica * 0.2).toFixed(1))
                var ukupnaVrednost = (parseFloat(poreskaOsnovica) + parseFloat(pdv)).toFixed(1)

                if (ukupnoDinara != "") {
                    $('#poreskaOsnovica').val(poreskaOsnovica)
                    $('#pdv').val(pdv + '0')
                    $('#ukupnaVrednost').val(numberFormat(ukupnaVrednost) + '0')
                } else {
                    $('#poreskaOsnovica').val('')
                    $('#pdv').val('')
                    $('#ukupnaVrednost').val('')
                }
            })

            $('#poreskaOsnovica').on('input', function () {                                     //Da na osnovu unosa polja Poreska Osnovica prekopira vrednost u polje Ukupnp Dinara i preracuna i popuni polja PDV i Ukupna Vrednost. Sa zaokruženim vrednodnostima decimala na pr 12,46 => 12,50

                decimals(this.getAttribute('Id'), this.value, 18, 2)
                numbersAndDotOnly(this.getAttribute('Id'), this.value)

                var poreskaOsnovica = this.value
                $('#ukupnoDinara').val(poreskaOsnovica)

                if (poreskaOsnovica != "") {
                    var pdv = numberFormat((poreskaOsnovica * 0.2).toFixed(1))
                    var ukupnaVrednost = (parseFloat(poreskaOsnovica) + parseFloat(pdv)).toFixed(1)

                    $('#pdv').val(pdv + '0')
                    $('#ukupnaVrednost').val(numberFormat(ukupnaVrednost) + '0')
                } else {
                    $('#pdv').val('')
                    $('#ukupnaVrednost').val('')
                }
            })















            $('#racunBr, #myDatalistInput').on('input', function () {                   //na osnovu popunjenih polja prikazuje dugme "Prikaži" ili "PDF" i setuje atribut target="_blank" kada je PDF dugme
                var value = $('#racunBr').val();
                var stanica = $('#myDatalistInput').val();

                if (value != "" && stanica != "") {
                    $('#form1').attr('target', '_blank');
                    $('#pretraziBtn').text("PDF");
                } else {
                    $('#form1').removeAttr('target', '_blank');
                    $('#pretraziBtn').text("Pretraži");
                }
            })


         

            $('#fakturaGod').keypress(function (e) {                            //dozvoljava samo brojeve
                var charCode = (e.which) ? e.which : event.keyCode
                if (String.fromCharCode(charCode).match(/[^0-9]/g))
                    return false;
            });






            /********************       FUNKCIJE        ******************************/

            function decimals(selector, val, celiBrojevi, decimale) {                 //FUNKCIJA ZA DECIMALE, prosledjuje se selektor, vrednost, celobrijna vrednos i decimalna
                var separate = val.split('.')
                if (separate.length == 1) {
                    $('#' + selector).val(function () {
                        return val.substr(0, celiBrojevi)
                    })
                } else if (separate.length == 2) {
                    var sum = parseInt(separate[0].length) + parseInt(decimale) + 1
                    $('#' + selector).val(function () {
                        return val.substr(0, sum)
                    })
                }
            }

            function numbersAndDotOnly(selector, input) {                       //Da prilikom unosa zareza prebaci da bude tačka
                input = input.replace(",", ".");
                var res = "";
                //da ne moze prvi karakter da bude tacka
                if (input.charAt(0) == '.') {
                    input = input.replace(/\.+$/, "");
                }
                //da ne moze dve tacke da ubaci
                if (input.split('.').length > 2) {
                    input = input.replace(/\..+$/, ".");
                }
                //regex za brojeve i tacke
                function validate(s) {
                    var rgx = /^[0-9]*\.?[0-9]*$/;
                    return s.match(rgx);
                }
                for (var i = 0; i < input.length; i++) {
                    if (validate(input[i]) != null) {
                        res += input[i]
                    }
                }
                $('#' + selector).val(res)
            }

            function numberFormat(nStr) { //funkcija za formatiranje brojeva na pr 3,831,527.40
                nStr += '';
                x = nStr.split('.');
                x1 = x[0];
                x2 = x.length > 1 ? '.' + x[1] : '';
                var rgx = /(\d+)(\d{3})/;
                while (rgx.test(x1)) {
                    x1 = x1.replace(rgx, '$1' + ',' + '$2');
                }
                return x1 + x2;
            }




        })


    </script>
}
